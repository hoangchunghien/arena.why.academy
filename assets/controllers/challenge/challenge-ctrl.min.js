var app=angular.module("arena.challenge.controller",["ui.router","arena.audio.service","arena.users.service","arena.users.facebook.service"]);app.controller("arena.challenge.ctrl",["delegate","$scope","$state","$http","$timeout","userSrv","audioSrv","facebookSrv",function(e,t,n,r,i,s,o,u){var a=this;var f=10;var l;var c;var h;var p;var d;var v;var m;var g;t.medalUrl;t.profile=s.getProfile();e.destroy=function(){$("#startModalChallenge").modal("hide");$("#finishModalChallenge").modal("hide");$("body").removeClass("modal-open");$(".modal-backdrop").remove();clearTimeout(g);clearTimeout(m);o.destroyAllSound();l.destroy();delete l};t.showCheckCorrectAnswer=false;var y=function(){i(function(){$("#showCheckCorrectAnswer").modal("show")},200);i(function(){$("#showCheckCorrectAnswer").modal("hide")},1800)};var b=function(){m=setTimeout(function(){t.ThreeToZero--;h.play();t.$apply();if(t.ThreeToZero>0){b()}else{setTimeout(function(){t.ThreeToZero="Bắt đầu !";p.play();t.$apply()},1e3)}},1e3)};var w=function(){$("#startModalChallenge").modal("show");b();setTimeout(function(){$("#startModalChallenge").modal("hide")},5e3)};t.clickAnswer=function(e){var n={};n.name="question_answer";n.data={answer:e};t.lastAnswered=e;l.consumeEvent(n)};t.getProgress=function(){return t.countDown/t.timeout*100+"%"};var E=function(e){o.playAudio(e)};t.reloadChallenge=function(){e.destroy();S()};this.handleEventNotification=function(e){console.log(e);switch(e.name){case"quiz_questioning":c.play();t.question=e.data.question;t.timeout+=e.data.timeout;console.log("quiz_questioning");console.log(t.timeout);break;case"question_ending":console.log("question_ending");var n=t.lastAnswered;if(e.data.correct){y();d.play();t.answers[n]={correct:1};t.score+=e.data.score;t.results[t.currentQuestion]={score:"+"+e.data.score,correct:1};t.showCorrect=true}else{v.play();t.answers[n]={correct:0};t.results[t.currentQuestion]={score:"+"+e.data.score,correct:0}}t.answers[e.data.correctAnswer]={correct:1};var r={yourAnswer:t.lastAnswered,correctAnswer:e.data.correctAnswer};t.tableOfResults.push(r);t.lastAnswered=null;t.$apply();break;case"question_answered":console.log("Answered");t.disabledButton=true;break;case"question_time_changed":console.log(e.name,e.data.remainingTime);t.countDown=e.data.remainingTime;t.$apply();break;case"question_next_question":console.log("next question");t.currentQuestion++;t.question=e.data.question;t.answers=[];t.disabledButton=false;t.showCorrect=false;break;case"quiz_finished_event":console.log("quiz_finished");if(t.score>=160){t.medalUrl="/data/image/gold-medal.png"}else if(t.score>=130){t.medalUrl="/data/image/silver-medal.png"}else if(t.score>100){t.medalUrl="/data/image/bronze-medal.png"}else{t.medalUrl=""}g=i(function(){$("#finishModalChallenge").modal("show")},1e3);break;case"quiz_initializing":break}};t.exitChallenge=function(){n.go("main")};var S=function(){c=o.getBackgroundAudio("/data/sound/starting.mp3",10);h=o.getCountDownAudio("/data/sound/countdown.mp3");p=o.getCountDownCoongAudio("/data/sound/coong.mp3");d=o.getCorrectAnswerAudio("/data/sound/true-answer.mp3");v=o.getWrongAnswerAudio("/data/sound/wrong-answer.mp3");t.results=[];t.answers=[];t.tableOfResults=[];t.score=0;t.currentQuestion=0;t.timeout=0;t.ThreeToZero=3;t.disabledButton=false;r.get("/data/data-encrypt.json").success(function(e){l=new QuizStateMachine(e.slice(20,30),a);t.numberOfQuestion=l.quiz.questions.length;for(var n=0;n<t.numberOfQuestion;n++){t.results.push({score:n+1,correct:null})}w()});var e=function(e){var t=[];var n=[];var r=e.length;while(t.length<10){var i=Math.random()*1e3;var s=Math.floor(i%r);if(n.indexOf(s)<0){t.push(e[s]);n.push(s)}}return t}};S();var x=function(){o.destroySound("backgroundAudio");o.destroySound("countDownAudio");o.destroySound("countDownCoongAudio");o.destroySound("wrongAnswerAudio");o.destroySound("correctAnswerAudio")}}]);app.directive("modalShow",function(e){return{restrict:"A",link:function(t,n,r){t.showModal=function(e,t){if(!t)t=n;if(e)$(t).modal("show");else $(t).modal("hide")};t.$watch(r.modalShow,function(e,n){t.showModal(e,r.$$element)});$(n).bind("hide.bs.modal",function(){e(r.modalShow).assign(t,false);if(!t.$$phase&&!t.$root.$$phase)t.$apply()})}}})